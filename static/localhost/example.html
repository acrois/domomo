<!doctype html>
<html>

<head>
  <title>Example Domainz</title>
  <script type="module">
    import { toDom } from 'https://esm.sh/hast-util-to-dom@4?bundle';
    import { toHtml } from "https://esm.sh/hast-util-to-html@9?bundle";

    function patch(obj, diffs) {
      let arrayDelQueue = [];
      const removeSymbol = Symbol("micropatch-delete");
      for (const diff of diffs) {
        if (!diff.path || diff.path.length === 0) continue;
        let currObj = obj;
        let diffPathLength = diff.path.length;
        let lastPathElement = diff.path[diffPathLength - 1];
        let secondLastPathElement = diff.path[diffPathLength - 2];
        for (let i = 0; i < diffPathLength - 1; i++) {
          currObj = currObj[diff.path[i]];
        }
        switch (diff.type) {
          case "CREATE":
          case "CHANGE":
            currObj[lastPathElement] = diff.value;
            break;
          case "REMOVE":
            if (Array.isArray(currObj)) {
              currObj[lastPathElement] = removeSymbol;
              arrayDelQueue.push(() => {
                if (secondLastPathElement !== undefined) {
                  currObj[secondLastPathElement] = currObj[
                    secondLastPathElement
                  ].filter((e) => e !== removeSymbol);
                } else {
                  obj = obj.filter((e) => e !== removeSymbol);
                }
              });
            } else {
              delete currObj[lastPathElement];
            }
            break;
        }
      }
      arrayDelQueue.forEach((arrayDeletion) => arrayDeletion());
      return obj;
    }

    if (!window.es) {
      window.es = new EventSource(window.location.href, {
        withCredentials: true,
      });
      es.addEventListener("open", ev => {
        console.log(ev);
      });
      es.addEventListener('init', ev => {
        const decoded = JSON.parse(ev.data);
        if (decoded) {
          window.esd = decoded;
          const tree = toDom(decoded, {});
          document.body = tree.body;
        }
      });
      es.addEventListener("step", ev => {
        const decoded = JSON.parse(ev.data);
        if (decoded) {
          const attempt = patch(window.esd, decoded);
          if (attempt) {
            window.esd = attempt;
            const tree = toDom(window.esd, {});
            document.body = tree.body;
          }
        }
      });
      es.addEventListener("error", ev => {
        console.log(ev);
      });
    }
  </script>
  <meta charset="utf-8" />
  <meta http-equiv="Content-type" content="text/html; charset=utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style type="text/css">
    body {
      background-color: #f0f0f2;
      margin: 0;
      padding: 0;
      font-family: -apple-system, system-ui, BlinkMacSystemFont, "Segoe UI", "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;

    }

    div {
      width: 75%;
      margin: 5em auto;
      padding: 2em;
      background-color: #fdfdff;
      border-radius: 0.5em;
      box-shadow: 2px 3px 7px 2px rgba(0, 0, 0, 0.02);
    }

    a:link,
    a:visited {
      color: #38488f;
      text-decoration: none;
    }

    @media (max-width: 700px) {
      div {
        margin: 0 auto;
        width: auto;
      }
    }

    .selected {
      /* box-sizing: border-box; */
      outline: 2px solid rgba(0, 68, 150, 0.571);
    }

    .dropper {
      /* box-sizing: border-box; */
      outline: 2px solid rgba(150, 0, 47, 0.703);
    }
  </style>
</head>

<body>
  <div>
    <h1>Example Domains are for sale in your area</h1>
    <p>Hi there. This is a message from your cats. We are here to tell you that this domain is for use in illustrative
      examples in documents. You may use this
      domain in literature without prior coordination or asking for permission.</p>
    <p>If you want more, <a href="https://www.iana.org/domains/example">More information...</a></p>
    <pre>
        L          TE
          A       A
            C    V
            R A
            DOU
            LOU
            REUSE
            QUE TU
            PORTES
          ET QUI T'
          ORNE O CI
          VILISÃ‰
          OTE-  TU VEUX
          LA    BIEN
          SI      RESPI
                  RER       - Apollinaire
      </pre>
  </div>
  <script type="module">
    const target = document;
    const listener = (e) => {
      // console.log(e.type, e.type, e);
    };

    for (const key in target) {
      if (/^on/.test(key)) {
        const eventType = key.substr(2);

        if (eventType == 'pointermove' || eventType == 'pointerrawupdate' || eventType == 'mousemove') {
          continue;
        }

        console.log('bind', eventType);
        target.addEventListener(eventType, listener);
      }
    }
    document.addEventListener('pointerover', e => {
      // console.log(e.type, e.target);
      if (!['HTML', 'BODY'].includes(e.target.tagName) && (
        document.designMode == 'on'
        || e.shiftKey
      )) {
        e.target.classList.add('selected');
        e.target.draggable = true;
      }
    });
    const goodTags = ['P', 'SPAN', 'A', 'PRE', 'H1', 'H2', 'H3', 'H4', 'H5', 'H6'];
    document.addEventListener('keydown', e => {
      if (!['HTML', 'BODY'].includes(e.target.tagName) && e.shiftKey) {
        e.target.classList.add('selected');
        e.target.draggable = true;
      }

      if (e.ctrlKey && e.shiftKey) {
        e.preventDefault();
      }

      if (e.key === 'Enter'
        && !e.ctrlKey
        && !e.shiftKey
        && e.target.isContentEditable
        && goodTags.includes(e.target.tagName)
      ) {
        e.preventDefault();

        if (e.target.tagName == 'PRE') {
          const selection = window.getSelection();
          const range = selection.getRangeAt(0);
          console.log(selection, range);
          // range.insertNode(br);
          // range.setStartAfter(br);
          // selection.removeAllRanges();
          // selection.addRange(range);
        }
        else {
          e.target.removeAttribute('contentEditable');
        }
      }
    });
    document.addEventListener('keyup', e => {
      // console.log(e.target);
      if (!['HTML', 'BODY'].includes(e.target.tagName) && e.shiftKey) {
        e.target.classList.remove('selected');
        e.target.removeAttribute('draggable');
      }

      if (e.ctrlKey && e.shiftKey) {
        e.preventDefault();

        // console.log(e.target);
        if (goodTags.includes(e.target.tagName)) {
          console.log(e.target.tagName, e.keyCode, e.code, e.key);
          if (e.code == 'Equal') {

          }
        }
      }
    });
    document.addEventListener('keyup', e => {
      const when = new Date().getTime();
      // console.log(e);
      if (e.keyCode == 17) {
        if (document.body.hasAttribute('data-cmd')) {
          const lastTimeRaw = +document.body.getAttribute('data-cmd');
          const lastTime = new Date(lastTimeRaw).getTime();
          const delta = when - lastTime;
          // console.log(when, lastTimeRaw, lastTime, delta);
          if (delta > 250) {
            document.body.removeAttribute('data-cmd');
          }
        }

        if (!document.body.hasAttribute('data-cmd')) {
          document.body.setAttribute('data-cmd', when + '')
        }
        else {
          document.designMode = document.designMode == 'on' ? 'off' : 'on';
          document.body.removeAttribute('data-cmd');
          document.querySelectorAll('[contenteditable]').forEach(c => c.removeAttribute('contentEditable'));

          if (document.designMode == 'off') {
            document.querySelectorAll('[class=selected]').forEach(c => c.classList.remove('selected'));
          }
        }
      }
    });
    document.addEventListener('click', e => {
      if (document.designMode == 'off') {
        document.querySelectorAll('[contenteditable]').forEach(c => {
          if (e.target !== c) {
            c.removeAttribute('contentEditable');
          }
        })
        console.log(e);
      }
      // if (e.ctrlKey) {
      //   // e.target.parent.contentEditable = true;
      //   e.target.contentEditable = true;
      //   e.target.focus();
      // }
    });
    document.addEventListener('dblclick', e => {
      if (document.designMode == 'off' && e.target.tagName !== 'HTML') {

        if (goodTags.includes(e.target.tagName)) {
          e.target.contentEditable = true;
          e.target.focus();
        }
      }
    });
    document.addEventListener('pointerout', e => {
      // console.log(e.type, e.target);
      e.target.classList.remove('selected');
      e.target.removeAttribute('draggable');
    });
    document.addEventListener('dragenter', e => {
      event.dataTransfer.dropEffect = "move";
    });
    document.addEventListener('dragstart', e => {
      event.dataTransfer.effectAllowed = "copyMove";

      if (!e.target.id) {
        e.target.id = crypto.randomUUID();
      }

      e.dataTransfer.setData('text/plain', e.target.id);
      e.dataTransfer.setDragImage(e.target, 10, 10);
    });
    document.addEventListener('dragover', e => {
      e.preventDefault();
      const canMoveTo = !['BODY', 'HTML'].includes(e.target.tagName);
      e.dataTransfer.dropEffect = canMoveTo ? 'move' : 'none';
      e.target.classList.add('dropper');

      document.querySelectorAll('.dropper').forEach(c => {
        if (e.target !== c) {
          c.classList.remove('dropper');
        }
      })
    });
    document.addEventListener('drop', e => {
      e.preventDefault();
      const d = e.dataTransfer.getData('text/plain');

      if (e.target
        && !['BODY', 'HTML'].includes(e.target.tagName)
      ) {
        const dragElement = document.getElementById(d);
        if (dragElement != e.target) {
          dragElement.removeAttribute('draggable');
          e.target.appendChild(dragElement);
        }
      }

      document.querySelectorAll('.dropper').forEach(c => c.classList.remove('dropper'))
    });

    const mutation = (mutationList, observer) => {
      for (const mutation of mutationList) {
        // if (mutation.type === "childList") {
        //   console.log("A child node has been added or removed.");
        // } else if (mutation.type === "attributes") {
        //   console.log(`The ${mutation.attributeName} attribute was modified.`);
        // }
        console.log(mutation);
      }
    };
    const observer = new MutationObserver(mutation);
    observer.observe(document.body, {
      attributes: true,
      childList: true,
      subtree: true,
      characterData: true,
      // attributeOldValue: true,
      // characterDataOldValue: true,
    });
    //observer.disconnect();
  </script>
</body>

</html>
